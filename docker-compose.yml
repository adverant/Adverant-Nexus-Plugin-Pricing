# WARNING: Local builds prohibited on Mac (ARM64 incompatibility)
# This docker-compose file contains 'build:' directives
#
# ❌ DO NOT RUN: docker-compose build (will fail in production)
# ✅ INSTEAD USE: ~/.docker-enforcement/remote-build.sh <service>
#
# All Docker builds must be done on remote server: 157.173.102.118
# See CLAUDE.md for detailed instructions

version: '3.8'

services:
  # Node.js Pricing Service
  nexus-pricing:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexus-pricing
    restart: unless-stopped
    ports:
      - "9030:9030"
    environment:
      NODE_ENV: production
      PORT: 9030
      HOST: 0.0.0.0
      LOG_LEVEL: info
      DATABASE_URL: postgresql://postgres:postgres@nexus-postgres:5432/nexus_pricing?schema=public
      ML_SERVICE_URL: http://nexus-pricing-ml:8000
      ML_SERVICE_TIMEOUT: 30000
      REDIS_URL: redis://nexus-redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-in-production}
      API_KEY: ${API_KEY:-change-in-production}
      RATE_LIMIT_MAX: 100
      RATE_LIMIT_TIMEWINDOW: 60000
      DEFAULT_CURRENCY: USD
      MIN_PRICE_FACTOR: 0.5
      MAX_PRICE_FACTOR: 3.0
      DEFAULT_PRICING_HORIZON_DAYS: 365
      ENABLE_COMPETITOR_TRACKING: false
      ENABLE_EVENT_DETECTION: false
      ENABLE_AB_TESTING: true
      ENABLE_PRICE_NOTIFICATIONS: true
      ENABLE_AUTO_PRICING: false
      PROPERTY_MANAGEMENT_URL: http://nexus-property-management:9020
      NEXUS_GRAPHRAG_URL: http://nexus-graphrag:8080
    depends_on:
      - nexus-pricing-ml
    networks:
      - nexus-network
    volumes:
      - pricing-data:/app/data
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:9030/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

  # Python ML Service
  nexus-pricing-ml:
    build:
      context: ./ml
      dockerfile: Dockerfile
    container_name: nexus-pricing-ml
    restart: unless-stopped
    ports:
      - "9031:8000"
    environment:
      MODELS_DIR: /app/models
      LOG_LEVEL: INFO
    networks:
      - nexus-network
    volumes:
      - ml-models:/app/models
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

networks:
  nexus-network:
    external: true

volumes:
  pricing-data:
    driver: local
  ml-models:
    driver: local
